{% extends "admin/change_list.html" %}
{% load i18n %}

{% block content %}

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DASHBOARD DE GRÃFICOS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="dashboard-charts" style="margin-bottom:30px">

  <!-- KPI Cards -->
  <div id="kpi-row" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:25px">
    <div class="kpi-card" style="background:linear-gradient(135deg,#17a2b8,#138496);color:#fff;padding:20px;border-radius:12px;text-align:center;box-shadow:0 4px 15px rgba(23,162,184,.3)">
      <div style="font-size:14px;opacity:.85;margin-bottom:5px">ğŸ’° Faturamento Total</div>
      <div id="kpi-fat-total" style="font-size:28px;font-weight:700">â€”</div>
    </div>
    <div class="kpi-card" style="background:linear-gradient(135deg,#28a745,#1e7e34);color:#fff;padding:20px;border-radius:12px;text-align:center;box-shadow:0 4px 15px rgba(40,167,69,.3)">
      <div style="font-size:14px;opacity:.85;margin-bottom:5px">ğŸ“… Faturamento MÃªs</div>
      <div id="kpi-fat-mes" style="font-size:28px;font-weight:700">â€”</div>
    </div>
    <div class="kpi-card" style="background:linear-gradient(135deg,#6f42c1,#5a32a3);color:#fff;padding:20px;border-radius:12px;text-align:center;box-shadow:0 4px 15px rgba(111,66,193,.3)">
      <div style="font-size:14px;opacity:.85;margin-bottom:5px">ğŸ« Ticket MÃ©dio</div>
      <div id="kpi-ticket" style="font-size:28px;font-weight:700">â€”</div>
    </div>
    <div class="kpi-card" style="background:linear-gradient(135deg,#fd7e14,#e8590c);color:#fff;padding:20px;border-radius:12px;text-align:center;box-shadow:0 4px 15px rgba(253,126,20,.3)">
      <div style="font-size:14px;opacity:.85;margin-bottom:5px">ğŸ“‹ Consultas (mÃªs)</div>
      <div id="kpi-cons-mes" style="font-size:28px;font-weight:700">â€”</div>
    </div>
    <div class="kpi-card" style="background:linear-gradient(135deg,#20c997,#12876f);color:#fff;padding:20px;border-radius:12px;text-align:center;box-shadow:0 4px 15px rgba(32,201,151,.3)">
      <div style="font-size:14px;opacity:.85;margin-bottom:5px">ğŸ“Š Total Consultas</div>
      <div id="kpi-cons-total" style="font-size:28px;font-weight:700">â€”</div>
    </div>
    <div class="kpi-card" style="background:linear-gradient(135deg,#e83e8c,#c2185b);color:#fff;padding:20px;border-radius:12px;text-align:center;box-shadow:0 4px 15px rgba(232,62,140,.3)">
      <div style="font-size:14px;opacity:.85;margin-bottom:5px">ğŸ‘¥ Pacientes</div>
      <div id="kpi-pacientes" style="font-size:28px;font-weight:700">â€”</div>
    </div>
    <div class="kpi-card" style="background:linear-gradient(135deg,#007bff,#0056b3);color:#fff;padding:20px;border-radius:12px;text-align:center;box-shadow:0 4px 15px rgba(0,123,255,.3)">
      <div style="font-size:14px;opacity:.85;margin-bottom:5px">ğŸ©º MÃ©dicos</div>
      <div id="kpi-medicos" style="font-size:28px;font-weight:700">â€”</div>
    </div>
  </div>

  <!-- Row 1: Faturamento DiÃ¡rio + Por MÃ©dico -->
  <div style="display:grid;grid-template-columns:2fr 1fr;gap:20px;margin-bottom:20px">
    <div style="background:#fff;border-radius:12px;padding:20px;box-shadow:0 2px 10px rgba(0,0,0,.08)">
      <h3 style="margin:0 0 15px;font-size:16px;color:#333">ğŸ“ˆ Faturamento â€” Ãšltimos 30 dias</h3>
      <canvas id="chartDiario" height="110"></canvas>
    </div>
    <div style="background:#fff;border-radius:12px;padding:20px;box-shadow:0 2px 10px rgba(0,0,0,.08)">
      <h3 style="margin:0 0 15px;font-size:16px;color:#333">ğŸ© Consultas por Especialidade</h3>
      <canvas id="chartEspec" height="110"></canvas>
    </div>
  </div>

  <!-- Row 2: Fat. por MÃ©dico + Top Pacientes -->
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px">
    <div style="background:#fff;border-radius:12px;padding:20px;box-shadow:0 2px 10px rgba(0,0,0,.08)">
      <h3 style="margin:0 0 15px;font-size:16px;color:#333">ğŸ¥ Faturamento por MÃ©dico</h3>
      <canvas id="chartMedico" height="130"></canvas>
    </div>
    <div style="background:#fff;border-radius:12px;padding:20px;box-shadow:0 2px 10px rgba(0,0,0,.08)">
      <h3 style="margin:0 0 15px;font-size:16px;color:#333">ğŸ† Top 5 Pacientes (gasto)</h3>
      <canvas id="chartTopPac" height="130"></canvas>
    </div>
  </div>

  <!-- Row 3: Mensal -->
  <div style="display:grid;grid-template-columns:1fr;gap:20px;margin-bottom:20px">
    <div style="background:#fff;border-radius:12px;padding:20px;box-shadow:0 2px 10px rgba(0,0,0,.08)">
      <h3 style="margin:0 0 15px;font-size:16px;color:#333">ğŸ“† Faturamento Mensal</h3>
      <canvas id="chartMensal" height="80"></canvas>
    </div>
  </div>

</div>
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• FIM DASHBOARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- Tabela original do admin continua abaixo -->
{{ block.super }}

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<script>
(function(){
  const BRL = v => v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});

  fetch('/api/dashboard/')
    .then(r => r.json())
    .then(d => {
      // â”€â”€ KPIs â”€â”€
      document.getElementById('kpi-fat-total').textContent  = BRL(d.kpis.faturamento_total);
      document.getElementById('kpi-fat-mes').textContent    = BRL(d.kpis.faturamento_mes);
      document.getElementById('kpi-ticket').textContent     = BRL(d.kpis.ticket_medio);
      document.getElementById('kpi-cons-mes').textContent   = d.kpis.consultas_mes;
      document.getElementById('kpi-cons-total').textContent = d.kpis.total_consultas;
      document.getElementById('kpi-pacientes').textContent  = d.kpis.total_pacientes;
      document.getElementById('kpi-medicos').textContent    = d.kpis.total_medicos;

      // â”€â”€ GrÃ¡fico: Faturamento diÃ¡rio (line) â”€â”€
      new Chart(document.getElementById('chartDiario'),{
        type:'line',
        data:{
          labels: d.diario.labels,
          datasets:[
            {label:'Faturamento (R$)',data:d.diario.faturamento,borderColor:'#17a2b8',backgroundColor:'rgba(23,162,184,.12)',fill:true,tension:.35,pointRadius:4,pointBackgroundColor:'#17a2b8'},
            {label:'NÂº Consultas',data:d.diario.qtd,borderColor:'#fd7e14',backgroundColor:'rgba(253,126,20,.10)',fill:false,tension:.35,yAxisID:'y1',pointRadius:3,borderDash:[5,5]}
          ]
        },
        options:{
          responsive:true,
          interaction:{mode:'index',intersect:false},
          scales:{
            y:{beginAtZero:true,ticks:{callback:v=>BRL(v)},title:{display:true,text:'R$'}},
            y1:{beginAtZero:true,position:'right',grid:{drawOnChartArea:false},title:{display:true,text:'Qtd'}}
          }
        }
      });

      // â”€â”€ GrÃ¡fico: Especialidade (doughnut) â”€â”€
      const cores = ['#17a2b8','#28a745','#fd7e14','#6f42c1','#e83e8c','#20c997','#007bff','#ffc107'];
      new Chart(document.getElementById('chartEspec'),{
        type:'doughnut',
        data:{
          labels: d.especialidades.labels,
          datasets:[{data:d.especialidades.values,backgroundColor:cores.slice(0,d.especialidades.labels.length),borderWidth:2}]
        },
        options:{responsive:true,plugins:{legend:{position:'bottom'}}}
      });

      // â”€â”€ GrÃ¡fico: Fat. por MÃ©dico (bar horizontal) â”€â”€
      new Chart(document.getElementById('chartMedico'),{
        type:'bar',
        data:{
          labels: d.fat_medico.labels,
          datasets:[
            {label:'Faturamento (R$)',data:d.fat_medico.values,backgroundColor:'rgba(23,162,184,.75)',borderRadius:6},
            {label:'NÂº Consultas',data:d.fat_medico.qtd,backgroundColor:'rgba(253,126,20,.65)',borderRadius:6}
          ]
        },
        options:{
          indexAxis:'y',
          responsive:true,
          scales:{x:{beginAtZero:true,ticks:{callback:v=>typeof v==='number'&&v>=100?BRL(v):v}}}
        }
      });

      // â”€â”€ GrÃ¡fico: Top pacientes (bar) â”€â”€
      new Chart(document.getElementById('chartTopPac'),{
        type:'bar',
        data:{
          labels: d.top_pacientes.labels,
          datasets:[{label:'Gasto Total (R$)',data:d.top_pacientes.values,backgroundColor:['#6f42c1','#e83e8c','#17a2b8','#28a745','#fd7e14'],borderRadius:6}]
        },
        options:{
          responsive:true,
          scales:{y:{beginAtZero:true,ticks:{callback:v=>BRL(v)}}}
        }
      });

      // â”€â”€ GrÃ¡fico: Mensal (bar + line combo) â”€â”€
      new Chart(document.getElementById('chartMensal'),{
        type:'bar',
        data:{
          labels: d.mensal.labels,
          datasets:[
            {label:'Faturamento (R$)',data:d.mensal.faturamento,backgroundColor:'rgba(40,167,69,.65)',borderRadius:6,order:2},
            {label:'NÂº Consultas',data:d.mensal.qtd,type:'line',borderColor:'#e83e8c',backgroundColor:'transparent',tension:.3,yAxisID:'y1',pointRadius:5,pointBackgroundColor:'#e83e8c',order:1}
          ]
        },
        options:{
          responsive:true,
          interaction:{mode:'index',intersect:false},
          scales:{
            y:{beginAtZero:true,ticks:{callback:v=>BRL(v)},title:{display:true,text:'R$'}},
            y1:{beginAtZero:true,position:'right',grid:{drawOnChartArea:false},title:{display:true,text:'Qtd'}}
          }
        }
      });
    })
    .catch(err => console.error('Erro ao carregar dashboard:', err));
})();
</script>
{% endblock %}
